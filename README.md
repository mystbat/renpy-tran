# RPY 文件 AI 辅助翻译工具

---

### **写在前面**

> 首先，我不是程序员，只是一个普通的游戏爱好者。我不会也看不懂 Python 代码。这个脚本是 DeepSeek、Qwen 和 Gemini 一起写出来的。因此，对于代码可能存在的 Bug 或不稳定性，我概不负责。

使用本脚本，默认您已经具备 Ren'Py 游戏汉化的基础知识，至少看过 [这个教程](https://www.bilibili.com/opus/852578762356686848 "大概是我目前见过最好的Renpy游戏翻译教程V2.0")，并了解 Ren'Py 汉化文件的基本结构。

---

## **脚本用途**

本脚本旨在利用 Python 调用在线 AI 大语言模型，对 Ren'Py 游戏的汉化文件（`.rpy`）进行自动化的处理和翻译。

## **脚本安装**

[下载 `2.0.7z`](https://github.com/mystbat/renpy-tran/releases/tag/v2.0)，并将所有文件解压到任意一个独立的目录中。

## **脚本启动**

-   `UI.bat`: **主程序**，整合了脚本的所有核心功能。
-   `RpyChecker.bat`: 一个简易的 Rpy 文件检查和修改器。

---

## **使用指南**

### **简易流程概览**

> 导出 RPY 文件到脚本目录 -> **RPY 文件预处理** -> **参数配置** (首次使用) -> **运行翻译功能** -> **错误查看器** (检查与修正) -> **输出为 RPY 文件** -> 将 `output` 目录中的 RPY 文件放回游戏

### **Step 1: 准备 RPY 文件**

1.  使用 Ren'Py SDK 自带的工具，从游戏中导出汉化脚本。
2.  将 `game/tl/chinese/` 目录中需要翻译的 `.rpy` 文件复制到本工具的根目录下。

### **Step 2: RPY 文件预处理**

1.  在主菜单中，点击 **`RPY 文件预处理`** 按钮。
2.  在弹出的窗口中，选择您刚刚放入工具目录的 `.rpy` 文件。

此操作会自动执行以下任务：
-   **提取内容**: 将 RPY 文件的对话和原文提取为 CSV 格式，便于后续处理。
-   **文件分割**: 将大型 CSV 文件分割成多个小文件，并存放在 `split_csv` 目录中。
    -   **注意**: 默认按 30 行分割。如果您使用支持更长上下文（高 Token 上限）的 AI 模型，可以在 **`参数配置`** 中调高此数值，以获得可能更好的翻译连贯性。
-   **备份**: 自动备份原始的 RPY 文件。

### **Step 3: 参数配置**

在主菜单中，点击 **`参数配置`**，填入您所使用的 AI 模型 API 地址和 `API Key`。

> **模型选择建议**:
> 我个人目前使用 `hunyuan`，在中文处理和价格上具有一定性价比。您也可以尝试硅基流动的免费 `Deepseek-8B` 等模型，但可能错误率较高，需要更多的人工修正工作。

-   **模型参数**: 建议将 `温度 (temperature)` 和 `Top P` 的值调低，以确保翻译结果的稳定性和准确性。
-   **提示词 (Prompt)**:
    -   `System Role`: 用于设定 AI 的整体规则。
    -   `User Role` / `Assistant Role`: 主要用于控制 AI 的输出格式，请根据实际翻译效果进行微调。

### **Step 4: 运行翻译**

配置好 `API Key` 后，点击主菜单的 **`运行翻译功能`** 按钮。

-   脚本会打开一个新窗口，将 `split_csv` 目录中的文件逐一发送给 AI 模型进行翻译。
-   翻译结果会以 `*-s.csv` 的格式保存在 `split_csv` 目录中。
-   此过程运行时，您可以进行其他操作。如果需要修改已翻译的内容，可以直接使用文本编辑器（如 Notepad++）打开对应的 `*-s.csv` 文件，参照其格式进行修改。

### **Step 5: 检查与修正错误**

>错误检查的功能已被合并进错误查看器，可无需使用
翻译完成后，使用主菜单的 **`错误查看器`** 功能对结果进行校对和修正。

1.  在错误查看器窗口中，点击 **`检查CSV错误`** 按钮，脚本会自动扫描所有 `*-s.csv` 文件。
2.  左侧列表会显示所有检查出的问题。点击具体问题，右侧窗口会高亮显示其在文件中的位置，下方窗口则提供原文作为对照。
3.  选中问题行后，可以在上方的文本框中直接修改，然后点击 **`保存修改`**。

> **注意**：
> 尽管脚本会自动定位错误行，但 AI 模型有时会返回多余的空行或格式错乱的内容，这可能导致显示的行号不准。如果未在指定行看到问题，请检查其上下文。

**常见问题处理说明：**

1.  **特征码缺失或错误**
    -   **定义**: 特征码是 Ren'Py 用于定位原文位置的 ID，AI 不应改动它。但AI抽风乱改相信你也是知道的。
    -   **常见错误**:
        -   **格式错误**: 最常见的是 AI 忘记了特征码末尾的冒号 `:`。
        -   **引号数量错误**: 对于 `old "xxx"` 格式的特征码，因为要和translate chinese格式的兼容，所以外面还会再套一层引号。AI 有时会搞错外部包裹的引号数量。
        -   **内容截断**: 网络不稳定或翻译敏感内容时，AI 的输出可能不完整，导致大量数据丢失。
        -   **抽风乱改**：偶尔也会出现AI模型瞎编一个md5码的情况。（并且我叫AI帮我排版的时候，他还不忘记把我这条删掉）
    -   **解决方法**:
        -   仔细参照下方显示的原文，手动修正特征码及其标点。对于大量标点符号遗漏、错位，使用文本编辑器批量替换可能更快。
        -   如果文件内容大量缺失，直接删除该 `*-s.csv` 文件，然后**重新执行 Step 4**。脚本会自动跳过已存在的文件，仅重新翻译被删除的部分。

2.  **包含英文原文**
    -   **原因**: AI 可能漏翻，或认为某些词语无需翻译。
    -   **解决方法**:
        -   请自行检查确认。少量遗漏可直接在查看器中修改。
        -   如果大量漏翻，建议删除对应的 `*-s.csv` 文件，并**重新执行 Step 4**。

3.  **包含英文引号**
    -   **原因**: 尽管提示词已要求，但 AI 仍可能使用英文引号 `"`，这会导致 Ren'Py 报错。
    -   **解决方法**: 在错误查看器中，选中包含英文引号的行，点击 **`修复选中行引号`** 按钮，脚本会自动将其替换为中文方块引号，然后保存即可。

> **重要提示：**
> 在进入下一步之前，请务必反复点击 **`检查CSV错误`** 按钮，直到所有问题都已解决！！！

### **Step 6: 输出最终 RPY 文件**

确认所有 `*-s.csv` 文件都已修正无误后，点击主菜单的 **`输出为RPY文件`** 按钮。

-   脚本会自动从 `csvbak` 目录中读取原始文件结构。
-   将 `split_csv` 目录中所有已修正的翻译内容，根据特征码精确地填充回去。
-   在 `output` 目录中生成最终的、可直接使用的 `.rpy` 文件。
-   最后，所有处理过的 `.csv` 文件会被移动到 `split_csv/bak` 目录中进行归档备份。

### **Step 7: 在output目录中复制已经完成的rpy文件**

 -   把`output` 目录中的 `.rpy` 文件复制到相应目录。
